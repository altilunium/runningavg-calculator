<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rating Graph Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    textarea {
      width: 100%;
      height: 100px;
    }
    canvas {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Runningavg Calculator</h1>
  <p>Paste your rating data below (e.g., <code>g = [83,80,...]</code>):</p>
  <textarea id="inputData">g = [83,80,93,97,96,93,98,98]
a = [90,87,98,94,82,93,98,95]
m = [87,91,93,89,87,86,86,98]
h = [81,83,84,95,95,84,86,83]</textarea>
  <br>
  <button onclick="generateGraph()">Generate Graph</button>
  <canvas id="ratingChart" width="800" height="400"></canvas>

  <script>
    function parseData(input) {
      const lines = input.trim().split('\n');
      const data = {};
      lines.forEach(line => {
        const match = line.match(/^(.*?)\s*=\s*\[(.*?)\]$/);
        if (match) {
          const key = match[1].trim();
          const values = match[2].split(',').map(x => parseFloat(x.trim()));
          data[key] = values;
        }
      });
      return data;
    }

    function movingAverage(arr) {
      let avg = 0;
      const result = [];
      for (let i = 0; i < arr.length; i++) {
        avg = (avg * i + arr[i]) / (i + 1);
        result.push(parseFloat(avg.toFixed(2)));
      }
      return result;
    }

    function getRandomColor(index) {
      const colors = [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 159, 64, 1)',
        'rgba(199, 199, 199, 1)'
      ];
      return colors[index % colors.length];
    }

    function generateGraph() {
      const rawData = document.getElementById('inputData').value;
      const data = parseData(rawData);

      const maxEpisodes = Math.max(...Object.values(data).map(arr => arr.length));
      const labels = Array.from({length: maxEpisodes}, (_, i) => i + 1);

      const datasets = Object.entries(data).map(([key, values], index) => {
        const ma = movingAverage(values);
        const lastAvg = ma[ma.length - 1];
        return {
          label: `${key} (${lastAvg})`,
          data: ma,
          borderColor: getRandomColor(index),
          backgroundColor: getRandomColor(index),
          fill: false,
          tension: 0.3
        };
      });

      const ctx = document.getElementById('ratingChart').getContext('2d');
      if (window.chartInstance) window.chartInstance.destroy();

      window.chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: ''
            },
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Episode'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Moving average rating'
              }
            }
          }
        }
      });
    }

    window.onload = generateGraph;
  </script>
</body>
</html>
